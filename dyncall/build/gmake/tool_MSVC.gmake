.SUFFIXES:
.SUFFIXES: .obj .c .cpp .s
OBJ_SUFFIX=.obj
LIB_PREFIX=
LIB_SUFFIX=.lib

# --- implied rules -----------------------------------------------------------

# --- assemble to coff --------------------------------------------------------

$(BUILD_DIR)/%.obj: %.asm
	ml /nologo /c /coff $(ASFLAGS) /Fo$@ $<


# --- compile C ---------------------------------------------------------------

$(BUILD_DIR)/%.obj: %.c
	cl /nologo /c $(CPPFLAGS) $(CFLAGS) /Fo$@ $<


# --- compile C++ -------------------------------------------------------------

$(BUILD_DIR)/%.obj: %.cpp
	cl /nologo /c /EHsc $(CPPFLAGS) $(CXXFLAGS) /Fo$@ $<

# --- create COFF library -----------------------------------------------------

$(BUILD_DIR)/%.lib: 
	lib /NOLOGO $^ /OUT:$@

# --- linker flags ------------------------------------------------------------

LINK_FLAGS = $(foreach X,$(LINK_LIBPATHS),/LIBPATH:$X) $(foreach X,$(LINK_LIBS),$X.lib)

# --- link target DLL ---------------------------------------------------------

$(BUILD_DIR)/%.dll: 
	link /NOLOGO /MACHINE:X86 /DLL $(LINK_FLAGS) /OUT:$@ $^

# --- link target EXE ---------------------------------------------------------

$(BUILD_DIR)/%.exe: 
	link /NOLOGO /MACHINE:x86 $(LINK_FLAGS) /OUT:$@ $^ 

# --- build/gmake debugging ---------------------------------------------------

.PHONY: info-tool
info-tool:
	@echo LINK_LIBFILES=$(LINK_LIBFILES)
info: info-tool

